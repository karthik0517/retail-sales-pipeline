name: Databricks CI/CD

on:
  push:
    branches:
      - dev
      - main

  pull_request:

  workflow_dispatch:
    inputs:
      target:
        description: "Deployment target (dev or prod)"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout Repository
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2️⃣ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3️⃣ Install Required Tools
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build
          pip install databricks-cli

      # 4️⃣ Build Wheel Package
      - name: Build Wheel
        run: |
          python -m build

      # 5️⃣ Set Deployment Target
      - name: Set Target
        id: set_target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "TARGET=prod" >> $GITHUB_ENV
          else
            echo "TARGET=dev" >> $GITHUB_ENV
          fi

      # 6️⃣ Configure Databricks Authentication
      - name: Configure Databricks Auth
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_ID=${{ secrets.DATABRICKS_CLIENT_ID }}" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_SECRET=${{ secrets.DATABRICKS_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "DATABRICKS_TENANT_ID=${{ secrets.DATABRICKS_TENANT_ID }}" >> $GITHUB_ENV

      # 7️⃣ Validate Bundle
      - name: Validate Bundle
        run: |
          databricks bundle validate --target $TARGET

      # 8️⃣ Deploy Bundle
      - name: Deploy Bundle
        run: |
          databricks bundle deploy --target $TARGET